<div align="center">
    <br><br><br><br><br><br><br><br>
	<font size="8">CX-CTL</font>
    <p>国辰轮式巡检控制板 CX-CTL 软硬件说明</p>
</div>
<div STYLE="page-break-after: always;"></div>

---

[TOC]

---

# 1 软件部分

## 1.1 软件架构

### 1.1.1 操作系统

RTOS（FreeRTOS v202112.00 & CMSIS OS v2）

### 1.1.2 硬件库

STM32F4xx_HAL_Driver（HAL v1.27.1）

### 1.1.3 外设通信

- CANOpen（canfestival v3）
- Modbus（FreeModbus v1.6）
- RS232

### 1.1.4 开发IDE

- Keil MDK5（v5.35.0.0）
- STM32CubeMX（v6.6.1）

---

## 1.2 代码结构

代码工程根文件夹 [CX-CTL](..\)

```tree
CX-CTL                                     CX-CTL 工程根文件夹
├─Bsp                                      ├─板支持包（外设驱动代码实现）
│  ├─Inc                                   │  ├─头文件 
│  └─Src                                   │  └─源文件 
├─CanOpen                                  ├─CanOpen 库（canfestival v3）
│  ├─Inc                                   │  ├─头文件 
│  └─Src                                   │  └─源文件
├─Core                                     ├─STM32CubeMX 自动生成初始化文件
│  ├─Inc                                   │  ├─头文件
│  └─Src                                   │  └─源文件
├─Doc                                      ├─说明文档
│  └─Pic                                   │  └─说明图片
├─Drivers                                  ├─官方驱动库
│  ├─CMSIS                                 │  ├─ARM架构芯片 CMSIS 相关库
│  │  ├─Device                             │  │  ├─芯片支持库
│  │  │  └─ST                              │  │  │  └─ST
│  │  │      └─STM32F4xx                   │  │  │      └─STM32F4 系列
│  │  │          ├─Include                 │  │  │          ├─头文件
│  │  │          └─Source                  │  │  │          └─源文件
│  │  │              └─Templates           │  │  │              └─例程模板
│  │  └─Include                            │  │  └─头文件
│  └─STM32F4xx_HAL_Driver                  │  └─STM32F4 系列 HAL 驱动库
│      ├─Inc                               │      ├─头文件
│      │  └─Legacy                         │      │  └─老版本兼容代码
│      └─Src                               │      └─源文件
├─Hardware                                 ├─外设驱动代码（硬件抽象层）
│  ├─Inc                                   │  ├─头文件
│  └─Src                                   │  └─源文件
├─MDK-ARM                                  ├─MDK 工程文件
│  ├─CX-CTL                                │  ├─CX-CTL 工程编译输出
│  ├─DebugConfig                           │  ├─调试配置
│  └─RTE                                   │  └─运行时
│      └─_CX-CTL                           │      └─_CX-CTL 工程
├─Middlewares                              ├─中间件
│  └─Third_Party                           │  └─第三方库
│      └─FreeRTOS                          │      └─FreeRTOS 库（FreeRTOS v202112.00）
│          └─Source                        │          └─源代码
│              ├─CMSIS_RTOS_V2             │              ├─CMSIS_RTOS_V2 接口
│              ├─include                   │              ├─头文件
│              └─portable                  │              └─移植适配文件
│                  ├─MemMang               │                  ├─内存管理
│                  └─RVDS                  │                  └─RVDS
│                      └─ARM_CM4F          │                      └─ARM_CM4F
├─Modbus                                   ├─Modbus 库（FreeModbus v1.6）
│  ├─Inc                                   │  ├─头文件
│  └─Src                                   │  └─源文件
└─Tasks                                    └─RTOS 任务实现函数
    ├─Inc                                      ├─头文件
    └─Src                                      └─源文件
```

---

# 2 硬件部分

当前为硬件版本 CX-CTL v1.2

![CX-CTL v1.1](.\Pic\CX-CTL.png)

## 2.1 IC 芯片

### 2.1.1 电源

- #### U1

  LM2576HV-5.：DC5V 稳压芯片，将 [J1](#J1) 输入的 DC12V 电源转为 DC5V 向整个 PCB 及小型外接设备供电。

  - 连接 [T1](#T1) 用于测试 DC5V 输出。

  ![U1](.\Pic\U1.png)

  ---

- #### U2

  AMS1117：DC3.3V LDO，将 [U1](#U1) 输出的 DC5V 转为 DC3.3V 向 PCB 上所有 3.3V 器件供电。

  - 连接 [T2](#T2) 用于测试 DC3.3V 输出。

  ![U2](.\Pic\U2.png)

  ---

- #### U3

  B0505S-2WR2：隔离电源，将 [U1](#U1) 输出的 DC5V 隔离输出，用于向 PCB 上所有需要隔离电源的器件供电。

  - 连接 [T3](#T3) 用于测试隔离 DC5V 输出。
  
  ![U3](.\Pic\U3.png)

---

### 2.1.2 MCU

- #### U4

  STM32F407VGT6
  
  ![U4](.\Pic\U4.png)

### 2.1.3 看门狗

- #### U5

  MAX823SEUK-T：看门狗芯片，用于监护 [U4](#U4) （MCU）程序运行。

  - 连接 [U4](#U4) （MCU）的 PC13 号引脚，用于喂狗；
  - 连接 [U4](#U4) （MCU）的 NRST 号引脚，用于复位 MCU。

  ![U5](.\Pic\U5.png)
  
---

### 2.1.4 通信

- #### U6

  FT232RL：USB 串口通信及 ISP 芯片。

  - 1 号引脚连接 [U4](#U4) （MCU）的 PA9 号引脚，用于串口（USART1）通信 RX 通道；
  - 5 号引脚连接 [U4](#U4) （MCU）的 PA10 号引脚，用于串口（USART1）通信 TX 通道；
  - 15 号引脚连接 [J8](#J8) 的 3号引脚，用于 USB 接口的 DP；
  - 16 号引脚连接 [J8](#J8) 的 2号引脚，用于 USB 接口的 DM。

  ![U6](.\Pic\U6.png)

---

### 2.1.5 保护

- #### U7

  SP0504BAHT：4 TVS 阵列。

  - 1 号引脚连接 [J8](#J8) 的 1 号引脚，做 USB 通信的 VBUS 输入过压防护；
  - 4 号引脚连接 [J8](#J8) 的 3 号引脚和 [U6](#U6) 的 15 号引脚，做 USB 通信的 DP 输入过压防护；
  - 5 号引脚连接 [J8](#J8) 的 2 号引脚和 [U6](#U6) 的 16 号引脚，做 USB 通信的 DM 输入过压防护。

  ![U7](.\Pic\U7.png)
  
  ---

- #### U10

  PESD1CAN：CAN 总线保护。

  - 1 号引脚连接 [J12](#J12) 的 2、3 号引脚和 [U11](#U11) 的 6 号引脚，做 CAN 通信的 CANL 输入过压防护；
  - 2 号引脚连接 [J12](#J12) 的 4、5 号引脚和 [U11](#U11) 的 7 号引脚，做 CAN 通信的 CANH 输入过压防护；

  ![U10](.\Pic\U10.png)

---

###  2.1.6 通信

- #### U8

  ISO3082：RS485 通信芯片。

  - 3  [U4](#U4) （MCU）的 PD2 号引脚，用于串口（UART5）通信 RX 通道；
  - 4、5 号引脚连接 [U4](#U4) （MCU）的 PE1 号引脚，用于RS485 芯片的收发模式选择；
  - 6 号引脚连接 [U4](#U4) （MCU）的 PC12 号引脚，用于串口（UART5）通信 TX 通道；
  - 12 号引脚连接 [J9](#J9) （MCU）的 3、4 号引脚，用于 RS485 通信 A；
  - 13 号引脚连接 [J9](#J9) （MCU）的 5、6 号引脚，用于 RS485 通信 B。

  ![U8](.\Pic\U8.png)

  ---

- #### U9

  MAX3232E：双串口芯片。

  - 7 号引脚过 10Ω 电阻连接 [J10](#J10) 的 3 号引脚，用于串口 1 通信 RX 通道；
  - 8 号引脚过 10Ω 电阻连接 [J10](#J10) 的 2 号引脚，用于串口 1 通信 TX 通道；
  - 9 号引脚连接 [U4](#U4) （MCU）的 PA1 号引脚，用于串口（UART4）通信 RX 通道；
  - 10 号引脚连接 [U4](#U4) （MCU）的 PA0 号引脚，用于串口（UART4）通信 TX 通道；
  - 11 号引脚连接 [U4](#U4) （MCU）的 PD5 号引脚，用于串口（USART2）通信 TX 通道；
  - 12 号引脚连接 [U4](#U4) （MCU）的 PD6 号引脚，用于串口（USART2）通信 RX 通道；
  - 13 号引脚过 10Ω 电阻连接 [J11](#J11) 的 3 号引脚，用于 RS232 通信 RX 通道；
  - 14 号引脚过 10Ω 电阻连接 [J11](#J11) 的 2 号引脚，用于 RS232 通信 TX 通道；

  ![U9](.\Pic\U9.png)

  ---

- #### U11

  ISO1050DUB CAN 通信芯片

  - 2 号引脚连接 [U4](#U4) （MCU）的 PD0 号引脚，做 CAN 通信的 CAN_RX 通道；
  - 3 号引脚连接 [U4](#U4) （MCU）的 PD1 号引脚，做 CAN 通信的 CAN_TX 通道；
  - 6 号引脚连接 [J12](#J12) 的 2、3 号引脚，CAN 通信的 CANL；
  - 7 号引脚连接 [J12](#J12) 的 4、5 号引脚，CAN 通信的 CANH。

  ![U11](.\Pic\U11.png)
  
---

### 2.1.7 EEPROM

- #### U12

  AT24C32：I2C EEPROM。

  - 5 号引脚连接 [U4](#U4) （MCU）的 PB11 号引脚，做 I2C 通信的 SDA；
  - 6 号引脚连接 [U4](#U4) （MCU）的 PB10 号引脚，做 I2C 通信的 SCL。
  
  >**Note:**
  >
  >此 I2C 总线还挂载了 板上的外部 I2C 设备接口（[J2](#J2)）,如需挂载外部设备，请注意 I2C 器件地址冲突问题。
  
  ![U12](.\Pic\U12.png)
  
---

### 2.1.8 光耦

- #### OC1

  PS2101-4：4 路光耦芯片。

  - 1 号引脚连接 [J13](#J13) 的 2 号引脚；
  - 3 号引脚连接 [J14](#J14) 的 2 号引脚；
  - 5 号引脚连接 [J15](#J15) 的 2 号引脚；
  - 7 号引脚连接 [J16](#J16) 的 2 号引脚；
  - 10 号引脚连接 [U4](#U4)（MCU）的 PA5 号引脚；
  - 12 号引脚连接 [U4](#U4)（MCU）的 PA4 号引脚；
  - 14 号引脚连接 [U4](#U4)（MCU）的 PA3 号引脚；
  - 16 号引脚连接 [U4](#U4)（MCU）的 PA2 号引脚。

  ![OC1](.\Pic\OC1.png)

---

## 2.2 接口端子

### 2.2.1 电源

- #### J1
  
  2x2 PIN CON4 母口：用于 DC12V 输入。
  
  - 1、2 号引脚连接外部地；
  - 3、4 号引脚连 DC12V 输入。
  
  ![J1](.\Pic\J1.png)
  
---

### 2.2.2 I2C

- #### J2

  4 PIN CON4-3.0 母口：用于外部 I2C 设备连接
  
  - 1 号引脚连接数字地；
  - 2 号引脚连接 [U4](#U4) （MCU）的 PB10 号引脚，做 I2C 通信的 SCL；
  - 3 号引脚连接 [U4](#U4) （MCU）的 PB11 号引脚，做 I2C 通信的 SDA；
  - 4 号引脚连接 DC5V；
  
  >**Note:**
  >
  >此 I2C 总线还挂载了 板上的 I2C EEPROM 芯片（[U12](#U12)）,如需使用此接口，请注意 I2C 器件地址冲突问题。
  
  ![J2](.\Pic\J2.png)
  
---

### 2.2.3 IO

- #### J3

  5 PIN SIP5-3.0 母口：用于 IO 直驱设备（继电器）。
  
  - 1 号引脚连接 [U4](#U4) （MCU）的 PE2 号引脚，做 RGB_PIN_G2 输出；
  - 2、4 号引脚连接数字地；
  - 3 号引脚连接 [U4](#U4) （MCU）的 PE3 号引脚，做 RGB_PIN_B 输出；
  - 5 号引脚连接 [U4](#U4) （MCU）的 PE3 号引脚，做 RGB_PIN_STR 输出。

  ![J3](.\Pic\J3.png)

  ---
  
- #### J17

  2 PIN CON2-3.0 母口：用于 IO 预留。
  
  - 1 号引脚连接 [U4](#U4) （MCU）的 PB13 号引脚，做预留 IO2 ；
  - 2 号引脚连接 [U4](#U4) （MCU）的 PB12 号引脚，做预留 IO1 ；

  ![J17](.\Pic\J17.png)

---

### 2.2.4 调试

- #### J4

  4 PIN CON4 公口：用于 SWD 程序下载及调试。
  
  - 1 号引脚连接数字地；
  - 2 号引脚连接 [U4](#U4) （MCU）的 PA14 号引脚，做 SWD 的 SWCLK；
  - 3 号引脚连接 [U4](#U4) （MCU）的 PA13 号引脚，做 SWD 的 SWDIO；
  - 4 号引脚连接 DC3.3V；

  ![J4](.\Pic\J4.png)

---

### 2.2.5 跳线

- #### J5

  2 PIN CON2-1.27 接口，用于看门狗复位无法烧程序时短接。
  
  ![J5](.\Pic\J5.png)

---

### 2.2.6 LED灯控

- #### J6

  6 PIN SIP3*2-3.0 母口，用于 RGBLED 输出。
  
  - 1 号引脚经驱动电路连接 [U4](#U4) （MCU）的 PA6 号引脚，做 G 通道输出；
  - 2 号引脚连接数字地；
  - 3 号引脚经驱动电路连接 [U4](#U4) （MCU）的 PA7 号引脚，做 R 通道输出；
  - 4、6 号引脚连接 DC12V 输出；
  - 5 号引脚经驱动电路连接 [U4](#U4) （MCU）的 PB0 号引脚，做 B 通道输出。

  ![J6](.\Pic\J6.png)

  ---
  
- #### J7

  2x2 PIN SIP2*2-2 母口，用于左右转向 LED 输出。
  
  - 1 号引脚经驱动电路连接 [U4](#U4) （MCU）的 PE8 号引脚，做左转向灯输出；
  - 2 号引脚连接数字地；
  - 3 号引脚经驱动电路连接 [U4](#U4) （MCU）的 PE7 号引脚，做右转向灯输出；
  - 4 号引脚连接 DC12V 输出。
  
  ![J7](.\Pic\J7.png)

---

### 2.2.7 通信

- #### J8

  5 PIN MINI USB 母口，用于串口通信与 ISP 编程。
  
  - 1 号引脚连接 DC5V 输出；
  - 2 号引脚过 10Ω 电阻连接 [U6](#U6) 芯片的 16 号引脚，做 USB 通信的 DM；
  - 3 号引脚过 10Ω 电阻连接 [U6](#U6) 芯片的 15 号引脚，做 USB 通信的 DP；
  - 4 号引脚悬空；
  - 5 号引脚连接数字地。

  ![J8](.\Pic\J8.png)

  ---
  
- #### J9

  2x4 PIN CON4*2-3.0 母口，用于 RS495 通信。
  
  - 1 号引脚连接 DC12V 输出；
  - 2 号引脚连接数字地；
  - 3、4 号引脚过 10Ω 电阻连接 [U8](#U8) 芯片的 12 号引脚，做 RS485 通信的 A 通道；
  - 5、6 号引脚过 10Ω 电阻连接 [U8](#U8) 芯片的 13 号引脚，做 RS485 通信的 B 通道；
  - 7、8 号引脚连接数字地。

  ![J9](.\Pic\J9.png)

  ---
  
- #### J10

  3 PIN CON3-2.54 母口，用于串口通信。
  
  - 1 号引脚连接数字地。
  - 2 号引脚过 10Ω 电阻连接 [U9](#U9) 芯片的 8 号引脚，做串口 1 通信的 RX 通道；
  - 3 号引脚过 10Ω 电阻连接 [U9](#U9) 芯片的 7 号引脚，做串口 1 通信的 TX 通道。

  ![J10](.\Pic\J10.png)

  ---
  
- #### J11

  DB9 公口，用于 RS232 通信。
  
  - 2 号引脚过 10Ω 电阻连接 [U9](#U9) 芯片的 14 号引脚，做 RS232 通信的 TX 通道；
  - 3 号引脚过 10Ω 电阻连接 [U9](#U9) 芯片的 13 号引脚，做 RS232 通信的 RX 通道；
  - 10、11 号引脚连接数字地。

  ![J11](.\Pic\ J11.png)

  ---
  
- #### J12

  6 PIN SIP6-3.0 母口，用于 CAN 通信。
  
  - 1、6 号引脚连接数字地；
  - 2、3 号引脚连接连接 [U11](#U11) 芯片的 6 号引脚，做 CAN 通信的 CANL 通道；
  - 4、5 号引脚连接连接 [U11](#U11) 芯片的 7 号引脚，做 CAN 通信的 CANH 通道。

  ![J12](.\Pic\J12.png)

---

### 2.2.8 隔离输入

- #### J13

  2 PIN SIP6-3.0 母口，用于充电桩铜极输入检测。
  
  - 1 号引脚连接光耦（[OC1](#OC1)）外部地1；
  - 2 号引脚过 3 个并联 47kΩ 电阻连接 [OC1](#OC1) 光耦 1 号引脚，做输入。

  ![J13](.\Pic\J13.png)

  ---
  
- #### J14

  2 PIN SIP6-3.0 母口，用于急停开关输入检测。
  
  - 1 号引脚连接 DC12V 输出；
  - 2 号引脚过 2 个并联 10kΩ 电阻连接 [OC1](#OC1) 光耦 3 号引脚，做输入。

  ![J14](.\Pic\J14.png)

  ---
  
- #### J15

  2 PIN SIP6-3.0 母口，用于碰撞开关输入检测。
  
  - 1 号引脚连接 DC12V 输出；
  - 2 号引脚过 2 个并联 10kΩ 电阻连接 [OC1](#OC1) 光耦 5 号引脚，做输入。
  
  ![J15](.\Pic\J15.png)
  
  ---
  
- #### J16 

  2 PIN SIP6-3.0 母口，用于预留输入检测。
  
  - 1 号引脚连接光耦（[OC1](#OC1)）外部地2；
  - 2 号引脚过 2 个并联 10kΩ 电阻连接 [OC1](#OC1) 光耦 7 号引脚，做输入。
  
  ![J16](.\Pic\J16.png)
  
---

## 2.3 其他板上外设

### 2.3.1 LED

#### 2.3.1.1 电源指示

- ##### LED1

  红色 LED 用于 [J1](#J1) 端子 DC12V 输入指示。
  
  ![LED1](.\Pic\LED1.png)
  
  ---
  
- ##### LED2

  红色 LED 用于 [U2](#U2) 芯片 DC3.3V 输出指示。
  
  ![LED2](.\Pic\LED2.png)
  
  ---
  
- ##### LED3

  红色 LED 用于 [U1](#U1) 芯片 DC5V 输出指示。
  
  ![LED3](.\Pic\LED3.png)
  
  ---
  
- ##### LED4

  红色 LED 用于 [U3](#U3) 芯片隔离 DC5V 输出指示。
  
  ![LED4](.\Pic\LED4.png)
  
---

#### 2.3.1.2 运行指示

- ##### LED5

  蓝色 LED 用于 [U4](#U4) （MCU）程序警告信息指示。
  
  ![LED5](.\Pic\LED5.png)
  
  ---
  
- ##### LED6

  绿色 LED 用于 [U4](#U4) （MCU）程序正常运行信息指示。
  
  ![LED6](.\Pic\LED6.png)
  
  ---
  
- ##### LED7

  红色 LED 用于 [U4](#U4) （MCU）程序错误信息指示。
  
  ![LED7](.\Pic\LED7.png)
  
---

#### 2.3.1.3 通信指示

- ##### LED8

  蓝色 LED 用于 [U6](#U6) 芯片 USB 串口通信接收数据指示。
  
  ![LED8](.\Pic\LED8.png)
  
  ---
  
- ##### LED9

  蓝色 LED 用于 [U6](#U6) 芯片 USB 串口通信发送数据指示。
  
  ![LED9](.\Pic\LED9.png)
  
---

### 2.3.2 测试点

- #### T1

  用于测试 [U1](#U1) 芯片 DC5V 输出电压。
  
  ![T1](.\Pic\T1.png)
  
  ---
  
- #### T2

  用于测试 [U2](#U2) 芯片 DC3.3V 输出电压。
  
  ![T2](.\Pic\T2.png)
  
  ---
  
- #### T3

  用于测试 [U3](#U3) 芯片隔离 DC5V 输出电压。
  
  ![T3](.\Pic\T3.png)
  
---

### 2.3.3 按键

- #### SW1

  SWP1-P2：用于 [U4](#U4) （MCU）的手动复位。
  
  ![SW1](.\Pic\SW1.png)

---

